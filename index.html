<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <!-- ×¢×™×¦×•×‘ ××¢×•×“×›×Ÿ: ×›×•×ª×¨×ª #0F2B46, ×›×¨×˜×™×¡×™ ×©×‘×•×¢, ×¢×™×’×•×œ×™ ×™×•×, ×›×¨×˜×™×¡×™ ×’×Ÿ ×¢× ×¤×¡ ×¡×˜×˜×•×¡ (×™×¨×•×§/××¤×•×¨/×›×ª×•×), ×›×¨×˜×™×¡ ×”×ª×§×“××•×ª -->
  <title>×“×™×•×•×— ×’× ×™× - ××¤×œ×™×§×¦×™×™×ª ×©×˜×—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0F2B46">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="×’× ×™ ×ª×§×•×•×”">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="logo-ganei-tikva.png">
  <link rel="apple-touch-icon" sizes="180x180" href="logo-ganei-tikva.png">
  <link rel="apple-touch-startup-image" href="logo-ganei-tikva.png">
  <style>
    :root {
      color-scheme: light;
      --municipal: #0F2B46;
      --primary: #0F2B46;
      --primary-dark: #0a1d2e;
      --accent: #ff9800;
      --bg: #f0f2f5;
      --card-bg: #ffffff;
      --border: #e0e0e0;
      --text: #111111;
      --text-muted: #666666;
      --danger: #c62828;
      --success: #2e7d32;
      --status-gray: #9e9e9e;
      --status-orange: #e65100;
      --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.06);
      --shadow-card: 0 2px 10px rgba(0, 0, 0, 0.08);
      --radius-lg: 14px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --tap-height: 48px;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      direction: rtl;
      text-align: right;
      -webkit-tap-highlight-color: transparent;
      /* ×ª××™×›×” ×‘××¡×š ××œ× â€“ ××™×™×¤×•×Ÿ ×¢× × ×•×˜×© */
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      min-height: 100vh;
      min-height: -webkit-fill-available;
    }

    body {
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      padding: 0;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .app-header {
      background: #0F2B46;
      background: var(--municipal);
      color: #fff;
      padding: 18px 16px 20px;
      padding-top: calc(18px + env(safe-area-inset-top));
      margin: 0;
      border-radius: 0;
      box-shadow: 0 2px 12px rgba(15, 43, 70, 0.35);
    }
    .app-header h1 {
      margin: 0 0 6px;
      font-size: 1.35rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .app-header .app-subtitle {
      font-size: 0.9rem;
      opacity: 0.92;
      margin-bottom: 6px;
    }
    .app-header .app-date {
      font-size: 0.9rem;
      opacity: 0.95;
      font-weight: 500;
    }

    .app-content {
      padding: 14px 12px 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .app-title {
      margin: 0 0 4px;
      font-size: 1.25rem;
      font-weight: 700;
    }

    .subtitle {
      margin: 0 0 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .card {
      background-color: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 10px 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(0,0,0,0.02);
    }

    .card + .card {
      margin-top: 4px;
    }

    details.instructions {
      margin-top: 4px;
    }

    details.instructions summary {
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      outline: none;
    }

    details.instructions p,
    details.instructions ul {
      margin-top: 6px;
      margin-bottom: 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .json-placeholder h2 {
      margin: 4px 0;
      font-size: 0.9rem;
    }

    .json-placeholder p {
      margin: 0 0 4px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .json-placeholder {
      background: #fff8e1;
      border-radius: var(--radius-md);
      padding: 8px 10px;
      border: 1px solid #ffe082;
      margin-top: 4px;
    }

    #app {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .pill-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn,
    button {
      font-family: inherit;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: var(--tap-height);
      padding: 0 12px;
      border-radius: var(--radius-md);
      border: none;
      outline: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background-color: var(--primary);
      color: #ffffff;
      box-shadow: var(--shadow-soft);
      transition: background-color 0.15s ease, transform 0.05s ease, box-shadow 0.1s ease;
      width: 100%;
    }

    .btn:active {
      transform: scale(0.98);
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
      background-color: var(--primary-dark);
    }

    .btn-secondary {
      background-color: #f1f3f4;
      color: var(--text);
      box-shadow: none;
      border: 1px solid var(--border);
    }

    .btn-secondary:active {
      background-color: #e0e0e0;
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      box-shadow: none;
    }

    .btn-back-yellow {
      background-color: rgba(255, 235, 59, 0.45);
      border: 1px solid rgba(255, 193, 7, 0.6);
      color: #6d5a00;
      box-shadow: none;
    }
    .btn-back-yellow:active {
      background-color: rgba(255, 235, 59, 0.65);
    }

    .btn-small {
      min-height: 36px;
      font-size: 0.85rem;
      padding: 0 8px;
      border-radius: var(--radius-sm);
    }

    .btn-danger {
      background-color: var(--danger);
      color: #ffffff;
    }

    .btn-success {
      background-color: var(--success);
      color: #ffffff;
    }

    .btn-sync-cloud {
      background-color: #2e7d32;
      color: #fff;
      border: none;
    }
    .btn-sync-cloud:active {
      background-color: #1b5e20;
    }

    .btn-sync-day {
      background-color: #0F2B46;
      color: #fff;
      border: none;
    }
    .btn-sync-day:active {
      background-color: #0a1d2e;
    }

    .badge-synced {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background-color: #e8f5e9;
      color: #2e7d32;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 6px;
    }

    .btn-icon {
      width: var(--tap-height);
      padding: 0;
    }

    .week-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .week-card {
      background: #fff;
      border-radius: var(--radius-lg);
      padding: 20px 16px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border: 2px solid #e0e0e0;
      transition: all 0.2s ease;
    }
    .week-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); border-color: #bdbdbd; }
    .week-card.active {
      background: #0F2B46;
      background: var(--municipal);
      color: #fff;
      border-color: #0F2B46;
      box-shadow: 0 4px 14px rgba(15, 43, 70, 0.4);
    }
    .week-card .week-card-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 4px; }
    .week-card .week-card-sub { font-size: 0.82rem; opacity: 0.9; }
    .week-card:not(.active) .week-card-title { color: #2e7d32; }
    .week-card:not(.active) .week-card-sub { color: var(--text-muted); }

    .day-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    .day-chip {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid #e0e0e0;
      font-size: 1.15rem;
      font-weight: 700;
      cursor: pointer;
      background: #f5f5f5;
      color: #757575;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .day-chip:hover { background: #eeeeee; border-color: #bdbdbd; }
    .day-chip.active {
      background: #0F2B46;
      background: var(--municipal);
      color: #fff;
      border-color: #0F2B46;
    }
    .day-chip:active { transform: scale(0.95); }

    .pill {
      flex: 1 1 calc(50% - 4px);
      min-width: 80px;
      text-align: center;
      background-color: #f1f3f4;
      color: var(--text);
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      min-height: var(--tap-height);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: none;
    }
    .pill.active {
      background-color: var(--primary);
      color: #ffffff;
      border-color: var(--primary-dark);
      box-shadow: var(--shadow-soft);
    }
    .pill:active { transform: scale(0.98); }

    .label {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .value-inline {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    input[type="date"],
    input[type="text"],
    input[type="search"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      font-size: 0.9rem;
      font-family: inherit;
      outline: none;
      min-height: var(--tap-height);
      background-color: #ffffff;
    }

    textarea {
      min-height: 90px;
      resize: vertical;
      padding-top: 8px;
      padding-bottom: 8px;
    }

    input:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(25, 118, 210, 0.2);
    }

    .field {
      margin-bottom: 8px;
    }

    .row {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .row.space-between {
      justify-content: space-between;
    }

    .row-wrap {
      flex-wrap: wrap;
    }

    .small-text {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .status-bar {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 4px;
    }

    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      background-color: #e3f2fd;
      color: var(--primary-dark);
      font-size: 0.78rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chip-muted {
      background-color: #eeeeee;
      color: var(--text-muted);
    }

    .progress-card {
      background: #fff;
      border-radius: var(--radius-lg);
      padding: 16px 18px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      border: 1px solid rgba(15, 43, 70, 0.08);
    }
    .progress-card .progress-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .progress-card .progress-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #0F2B46;
      background: var(--municipal);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: bold;
      flex-shrink: 0;
    }
    .progress-container {
      width: 100%;
      background-color: #e8eaed;
      border-radius: 999px;
      height: 12px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: #0F2B46;
      background: var(--municipal);
      width: 0%;
      transition: width 0.3s ease;
    }
    .progress-text {
      font-size: 0.95rem;
      margin-top: 0;
      color: var(--text);
      font-weight: 600;
    }

    .badges {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background-color: #f1f3f4;
      color: var(--text-muted);
    }

    .search-input {
      position: relative;
    }

    .search-input input {
      padding-right: 32px;
    }

    .search-input::before {
      content: "ğŸ”";
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      font-size: 0.9rem;
      pointer-events: none;
    }

    .garden-list {
      max-height: 260px;
      overflow-y: auto;
      margin-top: 6px;
    }

    .garden-item {
      width: 100%;
      text-align: right;
      padding: 14px 16px 14px 14px;
      border-radius: var(--radius-md);
      border: none;
      border-right: 4px solid #e0e0e0;
      background-color: #fff;
      margin-bottom: 10px;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    .garden-item:hover { box-shadow: 0 4px 14px rgba(0,0,0,0.1); }
    .garden-item.status-done { border-right-color: var(--success); }
    .garden-item.status-pending { border-right-color: var(--status-gray); }
    .garden-item.status-tasks { border-right-color: var(--status-orange); }

    .garden-item-info {
      flex: 1;
      min-width: 0;
    }
    .garden-item-name {
      font-weight: 700;
      font-size: 1rem;
      color: var(--text);
      margin-bottom: 4px;
    }
    .garden-item-status {
      font-size: 0.82rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .status-indicator {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-weight: bold;
      font-size: 1.1rem;
    }
    .status-indicator.status-done {
      background: #2e7d32;
      color: #fff;
    }
    .status-indicator.status-pending {
      background: #9e9e9e;
      color: #fff;
    }
    .status-indicator.status-tasks {
      background: #e65100;
      color: #fff;
    }

    .garden-item .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #bdbdbd;
    }
    .garden-item.visited .status-dot {
      background-color: var(--success);
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .toggle-switch {
      position: relative;
      width: 52px;
      height: 28px;
      border-radius: 999px;
      background-color: #e0e0e0;
      cursor: pointer;
      flex-shrink: 0;
    }

    .toggle-knob {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      transition: transform 0.2s ease, right 0.2s ease, left 0.2s ease;
    }

    .toggle-on {
      background-color: var(--success);
    }

    .toggle-on .toggle-knob {
      right: auto;
      left: 2px;
    }

    .image-grid {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .image-slot {
      flex: 1;
      min-width: 0;
      border-radius: var(--radius-md);
      border: 1px dashed #bdbdbd;
      background-color: #fafafa;
      padding: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: stretch;
      justify-content: flex-start;
    }

    .image-preview-wrapper {
      position: relative;
      width: 100%;
      padding-top: 70%;
      border-radius: var(--radius-sm);
      overflow: hidden;
      background-color: #eeeeee;
    }

    .image-preview-wrapper img {
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-empty {
      font-size: 0.75rem;
      color: #9e9e9e;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      inset: 0;
    }

    .image-actions {
      display: flex;
      gap: 4px;
    }

    .text-center {
      text-align: center;
    }

    .mt-4 { margin-top: 4px; }
    .mt-6 { margin-top: 6px; }
    .mt-8 { margin-top: 8px; }

    .hidden {
      display: none !important;
    }

    .footer-actions {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .inline-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .inline-buttons .btn {
      flex: 1;
    }

    .error-text {
      font-size: 0.8rem;
      color: var(--danger);
      margin-top: 2px;
    }

    .soft-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .breadcrumbs {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .breadcrumbs strong {
      color: var(--text);
    }

    .tag-pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      background-color: #f1f3f4;
      font-size: 0.75rem;
    }

    .tag-pill span {
      margin-left: 4px;
    }

    .hr-soft {
      border: none;
      border-top: 1px solid #eeeeee;
      margin: 6px 0;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.45);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 40;
      padding: 10px;
    }

    .modal {
      width: 100%;
      max-width: 480px;
      background-color: var(--card-bg);
      border-radius: 16px 16px 14px 14px;
      padding: 10px 12px 12px;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.25);
    }

    .modal-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
    }

    .modal-body {
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--text);
    }

    .modal-body p {
      margin: 2px 0;
    }

    .modal-footer {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .badge-warning {
      background-color: #fff3cd;
      color: #856404;
      border-radius: var(--radius-sm);
      padding: 4px 6px;
      font-size: 0.78rem;
      margin-top: 4px;
    }

    @media (min-width: 600px) {
      .page {
        padding-top: 16px;
        padding-bottom: 20px;
      }
    }

    /* ××¡×š ×¤×ª×™×—×” â€“ ×œ×•×’×•, ××›×¡×” ××ª ×›×œ ×”××¡×š ×›×•×œ×œ ××–×•×¨×™ × ×•×˜×© */
    .splash-screen {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #E6E6E6;
      transition: opacity 0.6s ease-out;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    .splash-screen.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    .splash-screen .splash-logo {
      max-width: 80vw;
      max-height: 55vh;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    .toast {
      position: fixed;
      bottom: calc(20px + env(safe-area-inset-bottom));
      right: 50%;
      transform: translateX(50%);
      max-width: 90%;
      padding: 12px 20px;
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      font-weight: 500;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 10000;
      transition: opacity 0.3s ease;
    }
    .toast.success { background-color: #2e7d32; color: #fff; }
    .toast.error { background-color: #c62828; color: #fff; }
  </style>
</head>
<body>
  <div id="splash-screen" class="splash-screen">
    <img src="logo-ganei-tikva.png" alt="×’× ×™ ×ª×§×•×•×”" class="splash-logo">
  </div>

    <div class="page">
    <header class="app-header">
      <h1>××¢×¨×›×ª × ×™×”×•×œ ×‘×“×™×§×•×ª ×’× ×™×</h1>
      <div class="app-subtitle">×“×™×•×•×— ×™×•××™ â€“ ×’× ×™ ×ª×§×•×•×”</div>
      <div class="app-date" id="app-header-date"></div>
    </header>

    <script id="gardens-data" type="application/json">
            {
                "week1": {
                  "×": [
                    "××§×œ×™×¤×˜×•×¡",
                    "×“×¨×š ×”×‘×©××™×",
                    "×˜×¨×•××Ÿ",
                    "×¡××˜×ª ×™×•×‘×œ×™×",
                    "×¤××¨×§ ××¤×¨×™×§×”",
                    "×¤×™× ×ª ×”×‘×©××™×"
                  ],
                  "×‘": [
                    "×“×¨×š ×”×¢××§",
                    "×“×¨×š ×”×ª××¨×™×",
                    "×“×¨×š ×”×ª×§×•×•×” - ×‘×™×Ÿ ××§×œ×™×¤×˜×•×¡ ×œ×“×¨×š ×”××œ×š",
                    "×¤××¨×§ ×”×ª××¨×™×"
                  ],
                  "×’": [
                    "×˜×™×™×œ×ª ×”×ª×§×•×•×ª - ×‘×™×Ÿ ×‘×§×¢×ª ×”×™×¨×“×Ÿ ×œ××©×™",
                    "×¢×™×Ÿ ×©××©",
                    "×‘×§×¢×ª ×”×™×¨×“×Ÿ",
                    "×¨×—×‘×ª ×‘×•× ×™ ×”×¢×™×¨ + ×—× ×™×•×Ÿ + ×’×’ ×¤×œ××™×",
                    "××¢×‘×¨ ××™×œ×•×ª 4-6 ×“×¨×š ×”××œ×š 5-7 (×‘×¨×™×›×”)",
                    "×“×¨×š ×”××’××™×",
                    "×“×¨×š ×”××œ×š - ×‘×™×Ÿ ×”×¢××§×™× ×œ×“×¨×š ×”×™×",
                    "×“×¨×š ×”×™× - ××“×¨×š ×”××œ×š ×œ×“×¨×š ××™×œ×•×ª"
                  ],
                  "×“": [
                    "×’× ×™× ×¦×¤×•×Ÿ",
                    "×’× ×™× ×§×˜×Ÿ ×”×ª×§×•×•×” ××™×œ×•×ª",
                    "×“×¨×š ××™×œ×•×ª",
                    "×“×¨×š ×”×ª×§×•×•×” - ×‘×™×Ÿ ×“×¨×š ×”××œ×š ×œ×“×¨×š ××™×œ×•×ª"
                  ],
                  "×”": [],
                  "×•": [],
                  "×©×™×©×™": []
                },
                "week2": {
                  "×": [
                    "×“×¨×š ×”×“×¨×™×",
                    "×“×¨×š ×”×™× - ×‘×™×Ÿ ×¨×—×•×‘ ×”×“×¨×™× ×œ×¨×—×•×‘ ×”×‘×¨×•×©",
                    "×”××•×¨× ×™×",
                    "×˜×™×™×œ×ª ×”×ª×§×•×•×ª - ×‘×™×Ÿ ××•×¨× ×™× ×œ×”×“×¨×™×",
                    "×¤××¨×§ ×’× ×™ ×¡×‘×™×•×Ÿ",
                    "×”×‘×¨×•×©"
                  ],
                  "×‘": [
                    "×“×¨×š ×”×™× - ×‘×™×Ÿ ×¨×—×•×‘ ×”×“×¨×™× ×œ×“×¨×š ×”××œ×š",
                    "×˜×™×™×œ×ª ×”×ª×§×•×•×ª - ×‘×™×Ÿ ×”×“×¨×™× ×œ×“×¨×š ×”××œ×š",
                    "×©×“×¨×ª × ×•×‘×”"
                  ],
                  "×’": [
                    "×’×™× ×•×Ÿ ×©×‘×™×œ ×ª×¨×‘×‘×•×ª× ×—× ×™×•×Ÿ ×××™×¨×™×",
                    "×“×¨×š ×”××©×™",
                    "××•×¢×“×•×Ÿ ×œ×§×©×™×© + ×ª×¨×‘×‘×•×ª×",
                    "××¢×‘×¨ ×”××©×™ 3 ×’×‘×•×œ ×§. ××•× ×•",
                    "××¢×‘×¨ ×”××©×™ 6-10 ××™×œ×•×ª 3 ×›×•×œ×œ ×©×‘×™×œ ×œ××’××™×",
                    "××¢×‘×¨ ×›×™×›×¨ ×”××©×™ + ×”×™× + ×ª×¢×œ×” ×’×‘×•×œ ×§. ××•× ×•"
                  ],
                  "×“": [
                    "×“×¨×š ×”×™× - ××“×¨×š ××™×œ×•×ª ×œ×“×¨×š ×”××©×™",
                    "×¤××¨×§ ×”××©×™",
                    "×¤×™× ×ª ××™×œ×•×ª-×”×™×",
                    "×“×¨×š ×”×ª×§×•×•×” - ×‘×™×Ÿ ×“×¨×š ××™×œ×•×ª ×œ×›× ×™×¡×” ××§×¨×™×ª ××•× ×•"
                  ],
                  "×”": [],
                  "×•": [],
                  "×©×™×©×™": []
                }
              }
              
        </script>

    <div id="app" class="app-content">
      <div class="status-bar" style="margin-bottom: 4px;">
        <span id="status-chip-garden" class="chip chip-muted">×œ× × ×‘×—×¨ ×’×Ÿ</span>
      </div>

      <div class="progress-card">
        <div class="progress-header">
          <div class="progress-icon" id="progress-icon">âœ“</div>
          <div id="progress-text" class="progress-text">0 ××ª×•×š 0 ×‘×“×™×§×•×ª ×”×•×©×œ××•</div>
        </div>
        <div class="progress-container">
          <div id="progress-bar" class="progress-bar"></div>
        </div>
      </div>

      <!-- ×‘×—×™×¨×ª ×©×‘×•×¢ -->
      <section id="step-week">
        <div class="week-cards">
          <button type="button" class="week-card" data-week="week1">
            <div class="week-card-title">×©×‘×•×¢ 1</div>
            <div class="week-card-sub">×¡×‘×‘ ×ª×—×–×•×§×”</div>
          </button>
          <button type="button" class="week-card" data-week="week2">
            <div class="week-card-title">×©×‘×•×¢ 2</div>
            <div class="week-card-sub">×¡×‘×‘ ×ª×—×–×•×§×”</div>
          </button>
        </div>
      </section>

      <!-- ×‘×—×™×¨×ª ×™×•× -->
      <section id="step-day" class="hidden">
        <div class="day-chips">
          <button type="button" class="day-chip" data-day="×">×</button>
          <button type="button" class="day-chip" data-day="×‘">×‘</button>
          <button type="button" class="day-chip" data-day="×’">×’</button>
          <button type="button" class="day-chip" data-day="×“">×“</button>
          <button type="button" class="day-chip" data-day="×”">×”</button>
          <button type="button" class="day-chip" data-day="×•">×•</button>
          <button type="button" class="day-chip" data-day="×©×™×©×™">×©</button>
        </div>
      </section>

      <!-- ×‘×—×™×¨×ª ×’×Ÿ -->
      <section id="step-garden" class="hidden">
        <div class="header-row">
          <div class="section-title">×‘×—×™×¨×ª ×’×Ÿ</div>
          <button type="button" class="btn-small btn-outline" id="btn-back-to-days">×—×–×¨×” ×œ×™×•×</button>
        </div>

        <div class="field search-input">
          <input type="search" id="garden-search" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©× ×’×Ÿ">
        </div>

        <div id="garden-list" class="garden-list"></div>
        <div id="garden-list-empty" class="small-text hidden">×œ× × ××¦××• ×’× ×™× ×œ×™×•× ×–×”. ×‘×“×§×• ××ª × ×ª×•× ×™ ×”Ö¾JSON.</div>
      </section>

      <!-- ×˜×•×¤×¡ ×“×•×— ×œ×’×Ÿ -->
      <section id="step-report" class="hidden">
        <div class="header-row">
          <div>
            <div class="section-title">×˜×•×¤×¡ ×“×•×— ×œ×’×Ÿ <span id="report-synced-badge" class="badge-synced hidden">×¡×•× ×›×¨×Ÿ</span></div>
            <div class="breadcrumbs" id="breadcrumbs-text"></div>
          </div>
          <button type="button" class="btn-small btn-back-yellow" id="btn-back-to-gardens">×—×–×¨×” ×œ×¨×©×™××ª ×”×’× ×™×</button>
        </div>

        <hr class="hr-soft">

        <!-- ×ª××¨×™×š ×‘×“×™×§×” -->
        <div class="field">
          <div class="label">×ª××¨×™×š ×‘×“×™×§×”</div>
          <input type="date" id="field-date">
          <div class="small-text mt-4">
            ×ª×¦×•×’×”: <span id="date-display">â€”</span>
          </div>
        </div>

        <!-- ×”×¢×¨×•×ª -->
        <div class="field">
          <div class="label">×”×¢×¨×•×ª</div>
          <textarea id="field-notes" placeholder="×¨×©××• ×”×¢×¨×•×ª ×›×œ×œ×™×•×ª ×¢×œ ××¦×‘ ×”×’×Ÿ, ×œ×™×§×•×™×™×, ×ª×™××•× ××•×œ ×¦×•×•×ª ×•×¢×•×“."></textarea>
        </div>

        <!-- ××©×™××•×ª ×œ×‘×™×¦×•×¢ -->
        <div class="field">
          <div class="label">××©×™××•×ª ×œ×‘×™×¦×•×¢</div>
          <div class="toggle-row">
            <span class="soft-label">×¡×™××•×Ÿ ×”×× × ×“×¨×©×•×ª ××©×™××•×ª ×”××©×š</span>
            <div id="tasks-toggle" class="toggle-switch">
              <div class="toggle-knob"></div>
            </div>
          </div>
          <div id="tasks-details-container" class="field hidden mt-4">
            <div class="label">×¤×™×¨×•×˜ ××©×™××•×ª</div>
            <textarea id="field-task-details" placeholder="×¤×™×¨×•×˜ ××œ× ×©×œ ×”××©×™××•×ª ×œ×‘×™×¦×•×¢, ××—×¨×™×•×ª ×•×–×× ×™×."></textarea>
          </div>
        </div>

        <!-- ×ª××•× ×•×ª -->
        <div class="field">
          <div class="label">×ª××•× ×•×ª (×¢×“ 3)</div>
          <div class="small-text">× ×™×ª×Ÿ ×œ×¦×œ× ××”××¦×œ××” ××• ×œ×‘×—×•×¨ ××”×’×œ×¨×™×”. ×”×ª××•× ×•×ª × ×“×—×¡×•×ª ××•×˜×•××˜×™×ª ×œ×¤× ×™ ×©××™×¨×”.</div>

          <div class="image-grid">
            <div class="image-slot" data-slot="0">
              <div class="image-preview-wrapper">
                <div class="image-empty">×ª××•× ×” 1</div>
                <img alt="" class="hidden">
              </div>
              <div class="image-actions">
                <button type="button" class="btn-small btn-secondary btn-image-replace" data-slot="0">×”×—×œ×£ / ×”×•×¡×£</button>
                <button type="button" class="btn-small btn-outline btn-image-remove" data-slot="0">×”×¡×¨</button>
              </div>
            </div>
            <div class="image-slot" data-slot="1">
              <div class="image-preview-wrapper">
                <div class="image-empty">×ª××•× ×” 2</div>
                <img alt="" class="hidden">
              </div>
              <div class="image-actions">
                <button type="button" class="btn-small btn-secondary btn-image-replace" data-slot="1">×”×—×œ×£ / ×”×•×¡×£</button>
                <button type="button" class="btn-small btn-outline btn-image-remove" data-slot="1">×”×¡×¨</button>
              </div>
            </div>
            <div class="image-slot" data-slot="2">
              <div class="image-preview-wrapper">
                <div class="image-empty">×ª××•× ×” 3</div>
                <img alt="" class="hidden">
              </div>
              <div class="image-actions">
                <button type="button" class="btn-small btn-secondary btn-image-replace" data-slot="2">×”×—×œ×£ / ×”×•×¡×£</button>
                <button type="button" class="btn-small btn-outline btn-image-remove" data-slot="2">×”×¡×¨</button>
              </div>
            </div>
          </div>

          <button type="button" id="btn-add-image" class="btn-small btn-outline mt-6">×”×•×¡×£ ×ª××•× ×” ×œ××§×•× ×¤× ×•×™</button>
          <div id="image-error" class="error-text hidden"></div>
          <input type="file" id="image-input" accept="image/*" capture="environment" class="hidden">
        </div>

        <hr class="hr-soft">

        <!-- ×›×¤×ª×•×¨×™ ×“×•×— ×œ×’×Ÿ -->
        <div class="footer-actions">
          <div class="inline-buttons">
            <button type="button" id="btn-mark-visited" class="btn btn-success">×¡×•××Ÿ ×›×‘×•×¦×¢</button>
            <button type="button" id="btn-clear-current" class="btn btn-secondary">× ×§×” ×“×•×— ×œ×’×Ÿ ×–×”</button>
            <button type="button" id="btn-download-report-html" class="btn btn-outline">×”×•×¨×“ ×“×•×—</button>
          </div>
          <button type="button" id="btn-clear-day" class="btn btn-outline btn-danger">× ×§×” ××ª ×›×œ ×”×“×•×—×•×ª ×©×œ ×”×™×•× ×”× ×‘×—×¨</button>
          <button type="button" id="btn-sync-current" class="btn btn-sync-cloud">×¡× ×›×¨×•×Ÿ ×œ×¢× ×Ÿ</button>
          <button type="button" id="btn-sync-day" class="btn btn-sync-day">×¡× ×›×¨×•×Ÿ ×™×•×</button>
          <div class="small-text">
           
          </div>
        </div>
      </section>
    </div>
  </div>

  <div id="toast" class="toast hidden" aria-live="polite"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // --- Supabase (cloud sync) â€“ ×”×—×œ×£ ×‘×¢×¨×›×™× ××”×¤×¨×•×™×§×˜ ×©×œ×š ×‘-Supabase ---
    const SUPABASE_URL = 'https://zrurkifzrfdyrpkwgoyz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpydXJraWZ6cmZkeXJwa3dnb3l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MzU0NTcsImV4cCI6MjA4NzAxMTQ1N30.TqFJBz4CCPrMOZsisH8188Mx85ZDSCfQJNetcsc-Vxs';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    (function () {
      'use strict';

      const STORAGE_KEY = 'gardenChecksAppState_v1';

      const defaultAppState = {
        selectedWeek: null,
        selectedDay: null,
        selectedGarden: null,
        reports: {}
      };

      let appState = loadState();
      let gardensData = loadGardensData();
      let saveTimeout = null;
      let imageReplaceIndex = null;

      const statusChipGarden = document.getElementById('status-chip-garden');
      const appHeaderDate = document.getElementById('app-header-date');
      const progressBarEl = document.getElementById('progress-bar');
      const progressTextEl = document.getElementById('progress-text');

      const stepWeek = document.getElementById('step-week');
      const stepDay = document.getElementById('step-day');
      const stepGarden = document.getElementById('step-garden');
      const stepReport = document.getElementById('step-report');
      const gardenListEl = document.getElementById('garden-list');
      const gardenListEmptyEl = document.getElementById('garden-list-empty');
      const gardenSearchInput = document.getElementById('garden-search');

      const breadcrumbsText = document.getElementById('breadcrumbs-text');
      const reportSyncedBadge = document.getElementById('report-synced-badge');
      const dateInput = document.getElementById('field-date');
      const dateDisplay = document.getElementById('date-display');
      const notesInput = document.getElementById('field-notes');
      const tasksToggle = document.getElementById('tasks-toggle');
      const tasksDetailsContainer = document.getElementById('tasks-details-container');
      const taskDetailsInput = document.getElementById('field-task-details');
      const imageInput = document.getElementById('image-input');
      const imageError = document.getElementById('image-error');

      const btnBackToDays = document.getElementById('btn-back-to-days');
      const btnBackToGardens = document.getElementById('btn-back-to-gardens');
      const btnAddImage = document.getElementById('btn-add-image');
      const btnMarkVisited = document.getElementById('btn-mark-visited');
      const btnClearCurrent = document.getElementById('btn-clear-current');
      const btnClearDay = document.getElementById('btn-clear-day');
      const btnDownloadReportHtml = document.getElementById('btn-download-report-html');
      const btnSyncCurrent = document.getElementById('btn-sync-current');
      const btnSyncDay = document.getElementById('btn-sync-day');
      const toastEl = document.getElementById('toast');

      function showToast(msg, isError) {
        if (!toastEl) return;
        toastEl.textContent = msg;
        toastEl.classList.remove('success', 'error', 'hidden');
        toastEl.classList.add(isError ? 'error' : 'success');
        clearTimeout(toastEl._tid);
        toastEl._tid = setTimeout(function () {
          toastEl.classList.add('hidden');
        }, 3500);
      }

      function weekToNum(weekKey) {
        return weekKey === 'week1' ? 1 : 2;
      }

      function compressImageToBlob(dataUrl) {
        return new Promise(function (resolve, reject) {
          var img = new Image();
          img.onload = function () {
            var canvas = document.createElement('canvas');
            var maxW = 1280;
            var w = img.width, h = img.height;
            if (w > maxW) {
              h = Math.round(h * maxW / w);
              w = maxW;
            }
            canvas.width = w;
            canvas.height = h;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            canvas.toBlob(function (blob) {
              resolve(blob);
            }, 'image/jpeg', 0.7);
          };
          img.onerror = reject;
          img.src = dataUrl;
        });
      }

      function safePathSegment(str) {
        return String(str).replace(/[^a-zA-Z0-9_\-\u0590-\u05FF]/g, '_').replace(/_+/g, '_') || 'garden';
      }

      function uploadToStorage(blob, path) {
        return supabase.storage.from('inspection-images').upload(path, blob, {
          contentType: 'image/jpeg',
          upsert: true
        }).then(function (result) {
          if (result.error) throw new Error(result.error.message);
          return supabase.storage.from('inspection-images').getPublicUrl(path).data.publicUrl;
        });
      }

      function insertInspection(row) {
        return supabase.from('inspections').insert(row).select('id').single().then(function (result) {
          if (result.error) throw new Error(result.error.message);
          return result.data;
        });
      }

      function syncReport(report, weekKey, dayKey, gardenName, dateVal, notes, tasksForExecution, taskDetails, imagesArr) {
        var weekNum = weekToNum(weekKey);
        var dateStr = (dateVal || '').slice(0, 10);
        var ts = Date.now();
        var basePath = dateStr + '/' + weekNum + '/' + safePathSegment(dayKey) + '/' + safePathSegment(gardenName);

        return Promise.all(imagesArr.slice(0, 3).map(function (dataUrl, i) {
          if (!dataUrl) return Promise.resolve(null);
          return compressImageToBlob(dataUrl).then(function (blob) {
            var fileName = ts + '_' + (i + 1) + '.jpg';
            var fullPath = basePath + '/' + fileName;
            return uploadToStorage(blob, fullPath);
          });
        })).then(function (urls) {
          var imageUrls = urls.filter(Boolean);
          var row = {
            week: weekNum,
            day: dayKey,
            garden_name: gardenName,
            inspected_at: dateStr,
            notes: (notes || '').slice(0, 5000) || null,
            tasks_for_execution: !!tasksForExecution,
            task_details: (taskDetails || '').trim() || null,
            images: imageUrls
          };
          return insertInspection(row);
        }).then(function (data) {
          var id = data && data.id;
          if (id) {
            report.syncedAt = new Date().toISOString();
            report.remoteId = id;
          }
          return id;
        });
      }

      function syncCurrentReport() {
        var weekKey = appState.selectedWeek;
        var dayKey = appState.selectedDay;
        var gardenName = appState.selectedGarden;
        if (!weekKey || !dayKey || !gardenName) {
          showToast('×‘×—×¨×• ×’×Ÿ ×œ×¤× ×™ ×¡× ×›×¨×•×Ÿ', true);
          return;
        }
        var report = getReport(weekKey, dayKey, gardenName);
        if (!report) {
          showToast('××™×Ÿ ×“×•×— ×œ×¡× ×›×¨×Ÿ', true);
          return;
        }
        if (report.syncedAt) {
          showToast('×”×“×•×— ×›×‘×¨ ××¡×•× ×›×¨×Ÿ ×œ×¢× ×Ÿ', false);
          return;
        }
        if (!report.visited) {
          showToast('×¡×× ×• ××ª ×”×“×•×— ×›×‘×•×¦×¢ ×œ×¤× ×™ ×¡× ×›×¨×•×Ÿ', true);
          return;
        }
        var dateVal = dateInput.value || report.date;
        if (!dateVal) {
          showToast('×”×•×¡×™×¤×• ×ª××¨×™×š ×‘×“×™×§×”', true);
          return;
        }
        btnSyncCurrent.disabled = true;
        var notes = notesInput.value.trim() || report.notes || '';
        var tasksForExecution = getToggleValue();
        var taskDetails = taskDetailsInput.value.trim() || report.taskDetails || '';
        var imagesArr = Array.isArray(report.images) ? report.images : [null, null, null];

        syncReport(report, weekKey, dayKey, gardenName, dateVal, notes, tasksForExecution, taskDetails, imagesArr)
          .then(function () {
            scheduleSave();
            showToast('×”×“×•×— ×¡×•× ×›×¨×Ÿ ×‘×”×¦×œ×—×”');
            showReportStep();
          })
          .catch(function (err) {
            if (err.message === 'Failed to fetch' || err.message === 'NetworkError') {
              showToast('××™×Ÿ ×—×™×‘×•×¨, ×™×¡×ª× ×›×¨×Ÿ ×›×©×ª× ×¡×” ×©×•×‘', true);
            } else {
              showToast('×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ: ' + (err.message || '× ×¡×• ×©×•×‘'), true);
            }
          })
          .finally(function () {
            btnSyncCurrent.disabled = false;
          });
      }

      function syncDay() {
        var weekKey = appState.selectedWeek;
        var dayKey = appState.selectedDay;
        if (!weekKey || !dayKey) {
          showToast('×‘×—×¨×• ×©×‘×•×¢ ×•×™×•×', true);
          return;
        }
        var gardens = gardensData[weekKey] && gardensData[weekKey][dayKey] ? gardensData[weekKey][dayKey] : [];
        var toSync = [];
        for (var g = 0; g < gardens.length; g++) {
          var r = getReport(weekKey, dayKey, gardens[g]);
          if (r && r.visited && !r.syncedAt) toSync.push({ name: gardens[g], report: r });
        }
        if (toSync.length === 0) {
          showToast('××™×Ÿ ×“×•×—×•×ª ×œ×”×¢×œ××” ×œ×™×•× ×–×”', false);
          return;
        }
        btnSyncDay.disabled = true;
        var done = 0;
        var fail = false;
        function next() {
          if (done >= toSync.length) {
            btnSyncDay.disabled = false;
            if (fail) showToast('×—×œ×§ ××”×“×•×—×•×ª ×œ× ×¡×•× ×›×¨× ×• â€“ × ×¡×• ×©×•×‘', true);
            else showToast('×¡×•× ×›×¨× ×• ' + toSync.length + ' ×“×•×—×•×ª', false);
            scheduleSave();
            showReportStep();
            renderGardenList();
            return;
          }
          var item = toSync[done];
          var report = item.report;
          var dateVal = report.date;
          if (!dateVal) { done++; next(); return; }
          syncReport(report, weekKey, dayKey, item.name, dateVal, report.notes, report.tasksForExecution, report.taskDetails, report.images || [null, null, null])
            .then(function () { done++; next(); })
            .catch(function () {
              fail = true;
              done++;
              next();
            });
        }
        next();
      }

      function loadGardensData() {
        const scriptEl = document.getElementById('gardens-data');
        if (!scriptEl) {
          return { week1: {}, week2: {} };
        }
        try {
          const text = scriptEl.textContent.trim();
          if (!text) {
            return { week1: {}, week2: {} };
          }
          const data = JSON.parse(text);
          if (!data.week1) data.week1 = {};
          if (!data.week2) data.week2 = {};
          return data;
        } catch (e) {
          console.error('×©×’×™××” ×‘×§×¨×™××ª JSON ×©×œ ×”×’× ×™×:', e);
          alert('×©×’×™××” ×‘×§×¨×™××ª × ×ª×•× ×™ ×¨×©×™××ª ×”×’× ×™× (JSON). ×‘×“×§×• ×©×”×¤×•×¨××˜ ×ª×§×™×Ÿ.');
          return { week1: {}, week2: {} };
        }
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return structuredClone(defaultAppState);
          const parsed = JSON.parse(raw);
          return Object.assign(structuredClone(defaultAppState), parsed);
        } catch (e) {
          console.error('×©×’×™××” ×‘×§×¨×™××ª localStorage:', e);
          return structuredClone(defaultAppState);
        }
      }

      function scheduleSave() {
        if (saveTimeout) {
          clearTimeout(saveTimeout);
        }
        saveTimeout = setTimeout(saveNow, 400);
      }

      function saveNow() {
        saveTimeout = null;
        try {
          if (appState.selectedWeek && appState.selectedDay && appState.selectedGarden) {
            const report = ensureReportEntry(appState.selectedWeek, appState.selectedDay, appState.selectedGarden);
            report.updatedAt = new Date().toISOString();
          }
          localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
        } catch (e) {
          console.error('×©×’×™××” ×‘×©××™×¨×” ×œ-localStorage:', e);
        }
        updateProgress();
      }

      function ensureReportEntry(weekKey, dayKey, gardenName) {
        if (!appState.reports[weekKey]) appState.reports[weekKey] = {};
        if (!appState.reports[weekKey][dayKey]) appState.reports[weekKey][dayKey] = {};
        if (!appState.reports[weekKey][dayKey][gardenName]) {
          appState.reports[weekKey][dayKey][gardenName] = {
            visited: false,
            date: null,
            notes: '',
            tasksForExecution: false,
            taskDetails: '',
            images: [null, null, null],
            updatedAt: null,
            syncedAt: null,
            remoteId: null
          };
        }
        return appState.reports[weekKey][dayKey][gardenName];
      }

      function getReport(weekKey, dayKey, gardenName) {
        if (!weekKey || !dayKey || !gardenName) return null;
        return appState.reports?.[weekKey]?.[dayKey]?.[gardenName] || null;
      }

      function hebrewWeekLabel(weekKey) {
        if (weekKey === 'week1') return '×©×‘×•×¢ 1';
        if (weekKey === 'week2') return '×©×‘×•×¢ 2';
        return '×œ× × ×‘×—×¨';
      }

      function formatDateDisplay(isoDate) {
        if (!isoDate) return 'â€”';
        try {
          const dt = new Date(isoDate);
          if (Number.isNaN(dt.getTime())) return 'â€”';
          return new Intl.DateTimeFormat('he-IL', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          }).format(dt);
        } catch (e) {
          return 'â€”';
        }
      }

      function todayIsoDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return year + '-' + month + '-' + day;
      }

      function updateStatusChips() {
        const gardenLabel = appState.selectedGarden ? appState.selectedGarden : '×œ× × ×‘×—×¨ ×’×Ÿ';
        statusChipGarden.textContent = gardenLabel;
        statusChipGarden.classList.toggle('chip-muted', !appState.selectedGarden);
      }

      function updateHeaderDate() {
        if (!appHeaderDate) return;
        appHeaderDate.textContent = new Date().toLocaleDateString('he-IL', {
          weekday: 'long',
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      }

      function updateProgress() {
        const weekKey = appState.selectedWeek;
        const dayKey = appState.selectedDay;
        if (!weekKey || !dayKey) {
          progressBarEl.style.width = '0%';
          progressTextEl.textContent = '0 ××ª×•×š 0 ×‘×“×™×§×•×ª ×”×•×©×œ××•';
          return;
        }

        const gardensForDay = gardensData[weekKey]?.[dayKey] || [];
        const total = gardensForDay.length;
        let done = 0;
        if (total > 0) {
          for (const name of gardensForDay) {
            const report = getReport(weekKey, dayKey, name);
            if (report && report.visited) done += 1;
          }
        }
        const percent = total > 0 ? Math.round((done / total) * 100) : 0;
        progressBarEl.style.width = percent + '%';
        progressTextEl.textContent = done + ' ××ª×•×š ' + total + ' ×‘×“×™×§×•×ª ×”×•×©×œ××•';
      }

      function renderWeekSelection() {
        const buttons = stepWeek.querySelectorAll('.week-card');
        buttons.forEach(btn => {
          const weekKey = btn.getAttribute('data-week');
          btn.classList.toggle('active', appState.selectedWeek === weekKey);
        });
      }

      function renderDaySelection() {
        const buttons = stepDay.querySelectorAll('.day-chip');
        buttons.forEach(btn => {
          const dayKey = btn.getAttribute('data-day');
          btn.classList.toggle('active', appState.selectedDay === dayKey);
        });
      }

      function renderGardenList() {
        gardenListEl.innerHTML = '';
        const weekKey = appState.selectedWeek;
        const dayKey = appState.selectedDay;
        const searchTerm = gardenSearchInput.value.trim().toLowerCase();

        if (!weekKey || !dayKey) {
          gardenListEmptyEl.classList.remove('hidden');
          gardenListEmptyEl.textContent = '×‘×—×¨×• ×©×‘×•×¢ ×•×™×•× ×›×“×™ ×œ×”×¦×™×’ ×’× ×™×.';
          return;
        }

        const gardens = gardensData[weekKey]?.[dayKey] || [];
        const filtered = gardens.filter(name => {
          if (!searchTerm) return true;
          return String(name).toLowerCase().includes(searchTerm);
        });

        if (filtered.length === 0) {
          gardenListEmptyEl.classList.remove('hidden');
          gardenListEmptyEl.textContent = '×œ× × ××¦××• ×’× ×™× ×ª×•×××™× ×œ×—×™×¤×•×© / ×œ×™×•× ×–×”.';
          return;
        }

        gardenListEmptyEl.classList.add('hidden');

        for (const name of filtered) {
          const item = document.createElement('button');
          item.type = 'button';
          item.className = 'garden-item';
          if (appState.selectedGarden === name) {
            item.style.border = '2px solid var(--municipal)';
          }
          const report = getReport(weekKey, dayKey, name);
          const visited = report && report.visited;
          const hasTasks = report && report.tasksForExecution;

          const info = document.createElement('div');
          info.className = 'garden-item-info';
          const nameEl = document.createElement('div');
          nameEl.className = 'garden-item-name';
          nameEl.style.display = 'flex';
          nameEl.style.alignItems = 'center';
          nameEl.style.gap = '6px';
          nameEl.style.flexWrap = 'wrap';
          nameEl.appendChild(document.createTextNode(name));
          if (report && report.syncedAt) {
            const syncedBadge = document.createElement('span');
            syncedBadge.className = 'badge-synced';
            syncedBadge.textContent = '×¡×•× ×›×¨×Ÿ';
            nameEl.appendChild(syncedBadge);
          }
          info.appendChild(nameEl);
          const statusText = document.createElement('div');
          statusText.className = 'garden-item-status';
          if (visited && hasTasks) {
            statusText.textContent = '×¡×˜×˜×•×¡ ×ª×—×–×•×§×”: ×™×© ××©×™××•×ª';
          } else if (visited) {
            statusText.textContent = '×¡×˜×˜×•×¡ ×ª×—×–×•×§×”: ×‘×•×¦×¢';
          } else {
            statusText.textContent = '×¡×˜×˜×•×¡ ×ª×—×–×•×§×”: ×œ× ×‘×•×¦×¢';
          }
          info.appendChild(statusText);

          const indicator = document.createElement('div');
          indicator.className = 'status-indicator';
          if (visited && hasTasks) {
            indicator.classList.add('status-tasks');
            indicator.textContent = '!';
            item.classList.add('status-tasks');
          } else if (visited) {
            indicator.classList.add('status-done');
            indicator.textContent = 'âœ“';
            item.classList.add('status-done');
          } else {
            indicator.classList.add('status-pending');
            indicator.textContent = 'â€¢';
            item.classList.add('status-pending');
          }

          item.appendChild(info);
          item.appendChild(indicator);
          item.addEventListener('click', function () {
            appState.selectedGarden = name;
            scheduleSave();
            updateStatusChips();
            renderGardenList();
            showReportStep();
          });

          gardenListEl.appendChild(item);
        }
      }

      function showReportStep() {
        stepReport.classList.remove('hidden');
        stepGarden.classList.add('hidden');
        const weekKey = appState.selectedWeek;
        const dayKey = appState.selectedDay;
        const gardenName = appState.selectedGarden;
        if (!weekKey || !dayKey || !gardenName) return;

        const labelWeek = hebrewWeekLabel(weekKey);
        breadcrumbsText.textContent = labelWeek + ' Â· ×™×•× ' + dayKey + ' Â· ×’×Ÿ ' + gardenName;

        const report = ensureReportEntry(weekKey, dayKey, gardenName);
        if (reportSyncedBadge) {
          reportSyncedBadge.classList.toggle('hidden', !report.syncedAt);
        }

        let dateVal = report.date;
        if (!dateVal) {
          dateVal = todayIsoDate();
          report.date = dateVal;
          scheduleSave();
        }
        dateInput.value = dateVal;
        dateDisplay.textContent = formatDateDisplay(dateVal);

        notesInput.value = report.notes || '';

        setTasksToggle(report.tasksForExecution);
        taskDetailsInput.value = report.taskDetails || '';
        tasksDetailsContainer.classList.toggle('hidden', !report.tasksForExecution);

        const images = report.images || [null, null, null];
        const slots = document.querySelectorAll('.image-slot');
        slots.forEach(slot => {
          const idx = Number(slot.getAttribute('data-slot'));
          const imgEl = slot.querySelector('img');
          const emptyEl = slot.querySelector('.image-empty');
          const data = images[idx];
          if (data) {
            imgEl.src = data;
            imgEl.classList.remove('hidden');
            emptyEl.classList.add('hidden');
          } else {
            imgEl.src = '';
            imgEl.classList.add('hidden');
            emptyEl.classList.remove('hidden');
          }
        });

        imageError.classList.add('hidden');
        imageError.textContent = '';
      }

      function setTasksToggle(on) {
        tasksToggle.classList.toggle('toggle-on', !!on);
      }

      function getToggleValue() {
        return tasksToggle.classList.contains('toggle-on');
      }

      function initListeners() {
        stepWeek.addEventListener('click', function (e) {
          const btn = e.target.closest('.week-card[data-week]');
          if (!btn) return;
          const weekKey = btn.getAttribute('data-week');
          appState.selectedWeek = weekKey;
          if (!appState.selectedDay) {
            appState.selectedDay = null;
            appState.selectedGarden = null;
          }
          scheduleSave();
          updateStatusChips();
          renderWeekSelection();
          stepDay.classList.remove('hidden');
          stepGarden.classList.add('hidden');
          stepReport.classList.add('hidden');
          updateProgress();
        });

        stepDay.addEventListener('click', function (e) {
          const btn = e.target.closest('.day-chip[data-day]');
          if (!btn) return;
          const dayKey = btn.getAttribute('data-day');
          appState.selectedDay = dayKey;
          appState.selectedGarden = null;
          scheduleSave();
          updateStatusChips();
          renderDaySelection();
          stepGarden.classList.remove('hidden');
          stepReport.classList.add('hidden');
          renderGardenList();
          updateProgress();
        });

        gardenSearchInput.addEventListener('input', function () {
          renderGardenList();
        });

        btnBackToDays.addEventListener('click', function () {
          stepGarden.classList.add('hidden');
          stepReport.classList.add('hidden');
          stepDay.classList.remove('hidden');
        });

        btnBackToGardens.addEventListener('click', function () {
          stepReport.classList.add('hidden');
          stepGarden.classList.remove('hidden');
          renderGardenList();
        });

        dateInput.addEventListener('change', function () {
          const weekKey = appState.selectedWeek;
          const dayKey = appState.selectedDay;
          const gardenName = appState.selectedGarden;
          const report = ensureReportEntry(weekKey, dayKey, gardenName);
          report.date = dateInput.value || null;
          dateDisplay.textContent = formatDateDisplay(report.date);
          scheduleSave();
        });

        notesInput.addEventListener('input', function () {
          const weekKey = appState.selectedWeek;
          const dayKey = appState.selectedDay;
          const gardenName = appState.selectedGarden;
          const report = ensureReportEntry(weekKey, dayKey, gardenName);
          report.notes = notesInput.value || '';
          scheduleSave();
        });

        tasksToggle.addEventListener('click', function () {
          const newVal = !getToggleValue();
          setTasksToggle(newVal);
          const weekKey = appState.selectedWeek;
          const dayKey = appState.selectedDay;
          const gardenName = appState.selectedGarden;
          const report = ensureReportEntry(weekKey, dayKey, gardenName);
          report.tasksForExecution = newVal;
          if (!newVal) {
            report.taskDetails = '';
            taskDetailsInput.value = '';
          }
          tasksDetailsContainer.classList.toggle('hidden', !newVal);
          scheduleSave();
        });

        taskDetailsInput.addEventListener('input', function () {
          const weekKey = appState.selectedWeek;
          const dayKey = appState.selectedDay;
          const gardenName = appState.selectedGarden;
          const report = ensureReportEntry(weekKey, dayKey, gardenName);
          report.taskDetails = taskDetailsInput.value || '';
          scheduleSave();
        });

        btnAddImage.addEventListener('click', function () {
          imageReplaceIndex = null;
          const weekKey = appState.selectedWeek;
          const dayKey = appState.selectedDay;
          const gardenName = appState.selectedGarden;
          const report = ensureReportEntry(weekKey, dayKey, gardenName);
          const images = report.images || [null, null, null];
          const emptyIndex = images.findIndex(v => !v);
          if (emptyIndex === -1) {
            showImageError('××™×Ÿ ××§×•× ×œ×ª××•× ×•×ª × ×•×¡×¤×•×ª. ××—×§×• ×ª××•× ×” ×§×™×™××ª ××• ×”×©×ª××©×• ×‘×”×—×œ×¤×”.');
            return;
          }
          imageInput.click();
        });

        const replaceButtons = document.querySelectorAll('.btn-image-replace');
        replaceButtons.forEach(btn => {
          btn.addEventListener('click', function () {
            const slotIdx = Number(btn.getAttribute('data-slot'));
            imageReplaceIndex = slotIdx;
            hideImageError();
            imageInput.click();
          });
        });

        const removeButtons = document.querySelectorAll('.btn-image-remove');
        removeButtons.forEach(btn => {
          btn.addEventListener('click', function () {
            const slotIdx = Number(btn.getAttribute('data-slot'));
            removeImageAt(slotIdx);
          });
        });

        imageInput.addEventListener('change', function () {
          const file = imageInput.files && imageInput.files[0];
          imageInput.value = '';
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (ev) {
            const img = new Image();
            img.onload = function () {
              const canvas = document.createElement('canvas');
              const maxWidth = 1280;
              let width = img.width;
              let height = img.height;
              if (width > maxWidth) {
                const ratio = maxWidth / width;
                width = maxWidth;
                height = Math.round(height * ratio);
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

              const weekKey = appState.selectedWeek;
              const dayKey = appState.selectedDay;
              const gardenName = appState.selectedGarden;
              const report = ensureReportEntry(weekKey, dayKey, gardenName);
              if (!Array.isArray(report.images)) {
                report.images = [null, null, null];
              }

              if (imageReplaceIndex !== null && imageReplaceIndex >= 0 && imageReplaceIndex <= 2) {
                report.images[imageReplaceIndex] = dataUrl;
              } else {
                const emptyIndex = report.images.findIndex(v => !v);
                if (emptyIndex === -1) {
                  showImageError('××™×Ÿ ××§×•× ×œ×ª××•× ×•×ª × ×•×¡×¤×•×ª. ××—×§×• ×ª××•× ×” ×§×™×™××ª ×œ×¤× ×™ ×”×•×¡×¤×”.');
                  return;
                } else {
                  report.images[emptyIndex] = dataUrl;
                }
              }

              scheduleSave();
              showReportStep();
              hideImageError();
            };
            img.onerror = function () {
              showImageError('×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×”×ª××•× ×”. × ×¡×• ×©×•×‘.');
            };
            img.src = ev.target.result;
          };
          reader.onerror = function () {
            showImageError('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥. × ×¡×• ×©×•×‘.');
          };
          reader.readAsDataURL(file);
        });

        btnMarkVisited.addEventListener('click', function () {
          const weekKey = appState.selectedWeek;
          const dayKey = appState.selectedDay;
          const gardenName = appState.selectedGarden;
          const report = ensureReportEntry(weekKey, dayKey, gardenName);
          if (!report.date) {
            report.date = todayIsoDate();
            dateInput.value = report.date;
            dateDisplay.textContent = formatDateDisplay(report.date);
          }
          report.visited = true;
          scheduleSave();
          updateProgress();
          renderGardenList();
        });

        btnClearCurrent.addEventListener('click', function () {
          if (!appState.selectedWeek || !appState.selectedDay || !appState.selectedGarden) return;
          const confirmClear = confirm('×œ××—×•×§ ××ª ×›×œ × ×ª×•× ×™ ×”×“×•×— ×¢×‘×•×¨ ×’×Ÿ ×–×”?');
          if (!confirmClear) return;
          const weekKey = appState.selectedWeek;
          const dayKey = appState.selectedDay;
          const gardenName = appState.selectedGarden;
          if (appState.reports?.[weekKey]?.[dayKey]?.[gardenName]) {
            delete appState.reports[weekKey][dayKey][gardenName];
          }
          scheduleSave();
          showReportStep();
          updateProgress();
          renderGardenList();
        });

        btnClearDay.addEventListener('click', function () {
          const weekKey = appState.selectedWeek;
          const dayKey = appState.selectedDay;
          if (!weekKey || !dayKey) return;
          const confirmClear = confirm('×œ××—×•×§ ××ª ×›×œ ×”×“×•×—×•×ª ×¢×‘×•×¨ ×”×™×•× ×”× ×‘×—×¨? ×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.');
          if (!confirmClear) return;
          if (appState.reports?.[weekKey]?.[dayKey]) {
            appState.reports[weekKey][dayKey] = {};
          }
          scheduleSave();
          showReportStep();
          updateProgress();
          renderGardenList();
        });

        btnDownloadReportHtml.addEventListener('click', function () {
          downloadReportAsHtml();
        });
        if (btnSyncCurrent) btnSyncCurrent.addEventListener('click', syncCurrentReport);
        if (btnSyncDay) btnSyncDay.addEventListener('click', syncDay);
      }

      function showImageError(msg) {
        imageError.textContent = msg;
        imageError.classList.remove('hidden');
      }

      function hideImageError() {
        imageError.textContent = '';
        imageError.classList.add('hidden');
      }

      function removeImageAt(index) {
        const weekKey = appState.selectedWeek;
        const dayKey = appState.selectedDay;
        const gardenName = appState.selectedGarden;
        const report = ensureReportEntry(weekKey, dayKey, gardenName);
        if (!Array.isArray(report.images)) {
          report.images = [null, null, null];
        }
        report.images[index] = null;
        scheduleSave();
        showReportStep();
      }

      function downloadReportAsHtml() {
        const weekKey = appState.selectedWeek;
        const dayKey = appState.selectedDay;
        const gardenName = appState.selectedGarden;
        if (!weekKey || !dayKey || !gardenName) {
          alert('×™×© ×œ×‘×—×•×¨ ×’×Ÿ (×©×‘×•×¢, ×™×•× ×•×’×Ÿ) ×œ×¤× ×™ ×”×•×¨×“×ª ×”×“×•×—.');
          return;
        }
        const report = ensureReportEntry(weekKey, dayKey, gardenName);
        const weekLabel = hebrewWeekLabel(weekKey);
        const dateVal = dateInput.value || report.date || todayIsoDate();
        const dateDisplayStr = formatDateDisplay(dateVal);
        const notes = notesInput.value.trim() || (report.notes || '').trim();
        const hasTasks = getToggleValue();
        const taskDetails = taskDetailsInput.value.trim() || (report.taskDetails || '').trim();
        const images = Array.isArray(report.images) ? report.images : [null, null, null];

        var imagesHtml = '';
        for (var i = 0; i < images.length; i++) {
          if (images[i]) {
            var safeSrc = String(images[i]).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            imagesHtml += '<div class="report-image"><img src="' + safeSrc + '" alt="×ª××•× ×” ' + (i + 1) + '"></div>';
          } else {
            imagesHtml += '<div class="report-image report-image-empty">×ª××•× ×” ' + (i + 1) + ' â€“ ×œ× ×”×•×¢×œ×ª×”</div>';
          }
        }

        var safeName = (gardenName + '_' + dateVal).replace(/[^a-zA-Z0-9_\-\u0590-\u05FF]/g, '_');
        var html = '<!DOCTYPE html>\n<html lang="he" dir="rtl">\n<head>\n  <meta charset="UTF-8">\n  <title>×“×•×— ×‘×“×™×§×” - ' + escapeHtml(gardenName) + '</title>\n  <style>\n    /* ×¢×™×¦×•×‘ ×”×“×•×— â€“ × ×™×ª×Ÿ ×œ×¢×¨×•×š ×œ×¤×™ ×”×¦×•×¨×š */\n    body { font-family: Arial, sans-serif; margin: 24px; direction: rtl; text-align: right; }\n    .report-title { font-size: 1.5em; margin-bottom: 1em; border-bottom: 1px solid #ccc; padding-bottom: 8px; }\n    .report-row { margin: 10px 0; }\n    .report-label { font-weight: bold; }\n    .report-images { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }\n    .report-image { width: 200px; min-height: 120px; border: 1px solid #ddd; padding: 8px; }\n    .report-image img { max-width: 100%; height: auto; display: block; }\n    .report-image-empty { color: #999; display: flex; align-items: center; justify-content: center; }\n  </style>\n</head>\n<body>\n  <!-- × ×™×ª×Ÿ ×œ×¢×¨×•×š ×¢×™×¦×•×‘ ×•×˜×§×¡×˜ ×‘×§×•×‘×¥. ×œ×¤×ª×™×—×” ×‘-Word: ×¤×ª×— ××ª ×”×§×•×‘×¥ ×‘-Word ×•×©××•×¨ ×›-.docx. ×œ-PDF: ×¤×ª×— ×‘×“×¤×“×¤×Ÿ ×•×”×“×¤×¡ (Ctrl+P) â†’ ×©××™×¨×” ×›-PDF. -->\n  <h1 class="report-title">×“×•×— ×‘×“×™×§×•×ª ×’× ×™×</h1>\n  <div class="report-row"><span class="report-label">×©×‘×•×¢:</span> ' + escapeHtml(weekLabel) + '</div>\n  <div class="report-row"><span class="report-label">×™×•×:</span> ' + escapeHtml(dayKey) + '</div>\n  <div class="report-row"><span class="report-label">×’×Ÿ:</span> ' + escapeHtml(gardenName) + '</div>\n  <div class="report-row"><span class="report-label">×ª××¨×™×š ×‘×“×™×§×”:</span> ' + escapeHtml(dateDisplayStr) + '</div>\n  <div class="report-row"><span class="report-label">×”×¢×¨×•×ª:</span><br>' + escapeHtml(notes || 'â€”') + '</div>\n  <div class="report-row"><span class="report-label">××©×™××•×ª ×œ×‘×™×¦×•×¢:</span> ' + (hasTasks ? '×›×Ÿ' : '×œ×') + '</div>\n' + (hasTasks ? '<div class="report-row"><span class="report-label">×¤×™×¨×•×˜ ××©×™××•×ª:</span><br>' + escapeHtml(taskDetails || 'â€”') + '</div>\n' : '') + '  <div class="report-row"><span class="report-label">×ª××•× ×•×ª:</span></div>\n  <div class="report-images">' + imagesHtml + '</div>\n</body>\n</html>';

        var blob = new Blob(['\uFEFF' + html], { type: 'text/html;charset=utf-8' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'report_' + safeName + '.html';
        a.click();
        URL.revokeObjectURL(a.href);
      }

      function escapeHtml(str) {
        if (!str) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;');
      }

      function restoreInitialUI() {
        renderWeekSelection();
        renderDaySelection();
        updateStatusChips();
        updateProgress();

        if (appState.selectedWeek) {
          stepDay.classList.remove('hidden');
        } else {
          stepDay.classList.add('hidden');
        }

        if (appState.selectedWeek && appState.selectedDay) {
          stepGarden.classList.remove('hidden');
          renderGardenList();
        } else {
          stepGarden.classList.add('hidden');
        }

        if (appState.selectedWeek && appState.selectedDay && appState.selectedGarden) {
          stepReport.classList.remove('hidden');
          stepGarden.classList.add('hidden');
          showReportStep();
        } else {
          stepReport.classList.add('hidden');
        }
      }

      document.addEventListener('DOMContentLoaded', function () {
        updateHeaderDate();
        var splash = document.getElementById('splash-screen');
        if (splash) {
          window.setTimeout(function () {
            splash.classList.add('fade-out');
            window.setTimeout(function () {
              splash.remove();
            }, 600);
          }, 1000);
        }
        initListeners();
        restoreInitialUI();
      });
    })();
  </script>
</body>
</html>
